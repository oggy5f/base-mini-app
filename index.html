<script>
document.addEventListener("DOMContentLoaded", () => {
  const connectBtn = document.getElementById("connectBtn");
  const walletAddress = document.getElementById("walletAddress");
  const checkinBtn = document.getElementById("checkinBtn");
  const scoreText = document.getElementById("scoreText");
  const mintResult = document.getElementById("mintResult");
  let score = 0;

  async function connectAndSetup() {
    try {
      if (!window.ethereum) {
        alert("MetaMask not detected!");
        return;
      }

      const accounts = await window.ethereum.request({
        method: "eth_requestAccounts",
      });

      const addr = accounts[0];
      walletAddress.innerText = addr;
      connectBtn.innerText = "Connected";

      setupForAddress(addr);
    } catch (e) {
      alert("Connection failed: " + e.message);
    }
  }

  function setupForAddress(addr) {
    scoreText.innerText = getScore(addr);

    checkinBtn.onclick = () => {
      const today = new Date().toLocaleDateString();
      const last = localStorage.getItem("lastCheckin_" + addr);

      if (last === today) {
        alert("Already checked in!");
        return;
      }

      localStorage.setItem("lastCheckin_" + addr, today);
      score = getScore(addr) + 1;
      saveScore(addr, score);
      scoreText.innerText = score;
      alert("Check-in successful!");
    };

    document.getElementById("mintBtn").onclick = () => {
      const badgeId = Math.floor(Math.random() * 10000);
      mintResult.innerText = "Badge Minted (Simulated): " + badgeId;
      alert("Badge Minted (Simulated): " + badgeId);
    };
  }

  function getScore(addr) {
    return Number(localStorage.getItem("score_" + addr) || 0);
  }

  function saveScore(addr, value) {
    localStorage.setItem("score_" + addr, value);
  }

  connectBtn.onclick = connectAndSetup;
});
</script>
