<script>
document.addEventListener("DOMContentLoaded", () => {

    const connectBtn = document.getElementById("connectBtn");
    const walletAddress = document.getElementById("walletAddress");
    const checkinBtn = document.getElementById("checkinBtn");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const mintBtn = document.getElementById("mintBtn");
    const mintResult = document.getElementById("mintResult");

    let score = 0;

    // ---- CONNECT WALLET ----
    async function connectWallet() {
        try {
            if (!window.ethereum) {
                alert("No wallet found. Install MetaMask or OKX Wallet.");
                return;
            }

            const accounts = await window.ethereum.request({
                method: "eth_requestAccounts"
            });

            const addr = accounts[0];
            walletAddress.innerText = addr;
            connectBtn.innerText = "Connected";

            loadProgress(addr);

        } catch (e) {
            alert("Connection failed: " + e.message);
        }
    }

    // ---- DAILY CHECK-IN ----
    function dailyCheckIn() {
        if (walletAddress.innerText === "Not connected") {
            alert("Connect wallet first!");
            return;
        }

        score++;
        scoreDisplay.innerText = score;
        saveProgress(walletAddress.innerText, score);
    }

    // ---- SAVE TO LOCAL STORAGE ----
    function saveProgress(addr, points) {
        localStorage.setItem("miniapp_" + addr, points);
    }

    function loadProgress(addr) {
        const saved = localStorage.getItem("miniapp_" + addr);
        if (saved) {
            score = parseInt(saved);
            scoreDisplay.innerText = score;
        }
    }

    // ---- MINT BADGE (SIMULATED) ----
    function mintBadge() {
        if (walletAddress.innerText === "Not connected") {
            alert("Connect wallet first!");
            return;
        }

        const badgeId = Math.floor(Math.random() * 100000);
        mintResult.innerText = "Badge Minted (Simulated): " + badgeId;
        alert("Badge Minted: " + badgeId);
    }

    // ---- EVENT LISTENERS ----
    connectBtn.onclick = connectWallet;
    checkinBtn.onclick = dailyCheckIn;
    mintBtn.onclick = mintBadge;
});
</script>
